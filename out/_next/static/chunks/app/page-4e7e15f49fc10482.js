(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{6601:function(){},7961:function(e,t,n){Promise.resolve().then(n.bind(n,8978))},8978:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return CryptoEuroMillionsUI}});var o=n(7437),a=n(2265),l=n(5274),s=n(4949),r=n(6061),c=n(1628);let i=(0,r.j)("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),d=a.forwardRef((e,t)=>{let{className:n,variant:a,size:l,asChild:r=!1,...d}=e,u=r?s.g7:"button";return(0,o.jsx)(u,{className:(0,c.cn)(i({variant:a,size:l,className:n})),ref:t,...d})});d.displayName="Button";var u=n(2442),g=n(6141),m=n(3067),h=n(5883),f=n(2851),p=n(2369),x=n(4689),w=n(9560),b=n(3446),y=n(2086),k=n(3438);let TicketService=class TicketService{static async getUserTickets(e){try{var t;console.log("Fetching tickets from backend API...");let n=await fetch("".concat((0,c.k)(),"/tickets/my"),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)}});if(!n.ok)return console.error("Backend tickets fetch failed:",n.status,n.statusText),[];let o=await n.json();console.log("Fetched tickets from backend:",o);let a=(null===(t=o.tickets)||void 0===t?void 0:t.map(e=>({id:e.id,date:e.created_at,main:e.numbers,stars:[e.powerball],price:e.price||.05,txSig:e.transaction_hash})))||[];return console.log("Converted to activities:",a),a}catch(e){return console.error("Error fetching tickets from backend:",e),[]}}static async getJackpot(){try{console.log("Fetching jackpot from backend API...");let e=await fetch("".concat((0,c.k)(),"/pot"),{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)return console.error("Backend jackpot fetch failed:",e.status,e.statusText),null;let t=await e.json();return console.log("Fetched jackpot from backend:",t),t}catch(e){return console.error("Error fetching jackpot from backend:",e),null}}};n(7133).Buffer;let range=e=>Array.from({length:e},(e,t)=>t+1),pickUnique=(e,t)=>{let n=[...e],o=[];for(let e=0;e<t;e++){let e=Math.floor(Math.random()*n.length);o.push(n[e]),n.splice(e,1)}return o},sortAsc=e=>[...e].sort((e,t)=>e-t),sendSolTransaction=async(e,t,n,o,a)=>{try{console.log("Creating SOL transaction:",{from:n.toString(),to:o.toString(),amount:a,amountLamports:a*k.LAMPORTS_PER_SOL});let l=new k.Transaction;l.add(k.SystemProgram.transfer({fromPubkey:n,toPubkey:o,lamports:a*k.LAMPORTS_PER_SOL}));let{blockhash:s}=await t.getLatestBlockhash();l.recentBlockhash=s,l.feePayer=n,console.log("Transaction created, sending for signature...");let r=await e.adapter.sendTransaction(l,t);console.log("Transaction sent, signature:",r),console.log("Waiting for transaction confirmation...");let c=await t.confirmTransaction(r,"confirmed");if(c.value.err)throw Error("Transaction failed: ".concat(c.value.err));return console.log("Transaction confirmed:",r),r}catch(e){throw console.error("SOL transaction error:",e),e}},v={main:{count:5,max:30,label:"Numbers"},stars:{count:1,max:10,label:"Lucky Star"},ticketPriceSOL:.05,scheduleLabel:"Fri 20:00 UTC"};function NumberBall(e){let{n:t,selected:n,onClick:a,disabled:l}=e;return(0,o.jsxs)("button",{onClick:()=>!l&&(null==a?void 0:a(t)),className:"relative inline-flex h-12 w-12 items-center justify-center rounded-full text-sm font-semibold transition-all "+(l?" bg-neutral-800 text-neutral-500 cursor-not-allowed":n?" bg-purple-600 text-white":" bg-neutral-900 text-white border border-neutral-700 active:scale-95"),"aria-pressed":n,disabled:l,children:[t,n&&(0,o.jsx)(u.Z,{className:"absolute -right-1 -top-1 h-4 w-4 text-white"})]})}function GridPicker(e){let{title:t,max:n,needed:l,selected:s,onToggle:r}=e,c=(0,a.useMemo)(()=>range(n),[n]),i=s.length;return(0,o.jsxs)("div",{className:"mb-6",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,o.jsx)("div",{className:"text-sm font-medium text-neutral-400",children:t}),(0,o.jsxs)("div",{className:"text-xs text-neutral-500",children:[i,"/",l]})]}),(0,o.jsx)("div",{className:"grid grid-cols-6 gap-2",children:c.map(e=>(0,o.jsx)(NumberBall,{n:e,selected:s.includes(e),onClick:r},e))})]})}function Countdown(e){let{target:t}=e,[n,l]=(0,a.useState)(!1),[,s]=(0,a.useState)(0);if(a.useEffect(()=>{l(!0);let e=setInterval(()=>s(e=>e+1),1e3);return()=>clearInterval(e)},[]),!n)return(0,o.jsxs)("div",{className:"flex items-center gap-2 text-xs text-neutral-400",children:[(0,o.jsx)(g.Z,{className:"h-3 w-3"}),"Draw in --h --m --s"]});let r=Math.max(0,Math.floor((t-Date.now())/1e3));return(0,o.jsxs)("div",{className:"flex items-center gap-2 text-xs text-neutral-400",children:[(0,o.jsx)(g.Z,{className:"h-3 w-3"}),"Draw in ",Math.floor(r/3600),"h ",Math.floor(r%3600/60),"m ",r%60,"s"]})}function CryptoEuroMillionsUI(){let[e,t]=(0,a.useState)([]),[n,s]=(0,a.useState)([]),[r,i]=(0,a.useState)("home"),[u,j]=(0,a.useState)([]),[N,S]=(0,a.useState)(!1),[T,P]=(0,a.useState)(null),[C,A]=(0,a.useState)(null),{user:E,isLoading:_,error:O,connectWallet:L,disconnect:U,wallet:W,connected:F,publicKey:M,setIsLoading:I}=(0,w.useAuth)(),{select:B,wallets:z}=(0,b.O)(),{connection:D}=(0,y.R)();(0,a.useEffect)(()=>{S(!0)},[]);let fetchUserTickets=async()=>{if(E&&E.token)try{console.log("Fetching user tickets from backend..."),console.log("Using auth token:",E.token);let e=await TicketService.getUserTickets(E.token);console.log("Successfully fetched tickets from backend:",e),j(e)}catch(e){console.error("Failed to fetch tickets from backend:",e),j([])}},fetchJackpot=async()=>{try{console.log("Fetching jackpot from backend...");let e=await TicketService.getJackpot();console.log("Successfully fetched jackpot:",e),P(e)}catch(e){console.error("Failed to fetch jackpot:",e),P(null)}},fetchCountdown=async()=>{try{console.log("Fetching countdown from backend...");let e=await fetch("".concat((0,c.k)(),"/countdown"),{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok){console.error("Countdown fetch failed:",e.status,e.statusText),A(null);return}let t=await e.json();console.log("Successfully fetched countdown:",t),A(t)}catch(e){console.error("Failed to fetch countdown:",e),A(null)}};(0,a.useEffect)(()=>{E&&fetchUserTickets()},[E]),(0,a.useEffect)(()=>{fetchJackpot(),fetchCountdown()},[]);let J=(0,a.useMemo)(()=>{let e=new Date;return e.setUTCHours(20,0,0,0),e.getTime()<Date.now()&&e.setUTCDate(e.getUTCDate()+1),e.getTime()},[]),K=E&&e.length===v.main.count&&n.length===v.stars.count,R=(0,a.useMemo)(()=>{if(!E||!E.walletAddress)return!1;if(W&&W.adapter.publicKey){let e=W.adapter.publicKey.toString(),t=E.walletAddress;return console.log("Account check:",{currentAddress:e,storedAddress:t,matches:e===t}),e!==t}return!1},[E,W,F,M]);function toggleMain(e){t(t=>t.includes(e)?t.filter(t=>t!==e):t.length>=v.main.count?t:[...t,e])}function toggleStar(e){s(t=>t.includes(e)?t.filter(t=>t!==e):t.length>=v.stars.count?t:[...t,e])}async function flashPickAndBuy(){if(!E||R){handleConnectWallet();return}let e=pickUnique(range(v.main.max),v.main.count),n=pickUnique(range(v.stars.max),v.stars.count),o=sortAsc(e),a=sortAsc(n);t(o),s(a),console.log("Flash pick selected:",{main:o,stars:a}),setTimeout(async()=>{try{await playNowWithNumbers(o,a)}catch(e){console.error("Flash pick and buy failed:",e)}},100)}function clearPick(){t([]),s([])}async function handleConnectWallet(){try{if(console.log("Available wallets:",z.map(e=>e.adapter.name)),z.length>0){let e=z.find(e=>"Phantom"===e.adapter.name);e?(console.log("Selecting Phantom wallet for UI consistency..."),B(e.adapter.name)):console.log("Phantom wallet not found in available wallets")}else console.log("No wallets available");await L()}catch(e){console.error("Connection failed:",e)}}async function playNow(){if(!E||R){handleConnectWallet();return}if(!K){alert("Select 5 numbers and 1 star or use Flash.");return}console.log("Playing with numbers:",{main:sortAsc(e),stars:sortAsc(n),canPlay:K,mainCount:e.length,starsCount:n.length}),await playNowWithNumbers(e,n)}async function playNowWithNumbers(e,t){if(!E||R){handleConnectWallet();return}if(!e||!t||e.length!==v.main.count||t.length!==v.stars.count){alert("Invalid number selection. Please try again.");return}console.log("Playing with provided numbers:",{main:sortAsc(e),stars:sortAsc(t),mainCount:e.length,starsCount:t.length});try{I(!0),console.log("Creating payment intent..."),console.log("Using token for payment:",E.token),console.log("Authorization header:","Bearer ".concat(E.token));let n=await fetch("".concat((0,c.k)(),"/payments/create-intent"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(E.token)},body:JSON.stringify({ticket_count:1})});if(!n.ok){console.error("Payment intent failed:",n.status,n.statusText);let e=await n.json();throw console.error("Payment error data:",e),console.error("Payment response headers:",Object.fromEntries(n.headers.entries())),console.error("Payment request headers sent:",{Authorization:"Bearer ".concat(E.token),"Content-Type":"application/json"}),Error(e.message||"Failed to create payment intent")}let o=await n.json();console.log("Payment intent created:",o),console.log("Executing SOL transaction...");let a=o.recipient_address;console.log("Treasury wallet:",a);let l=W.adapter.publicKey||M;if(!l)throw Error("User wallet not connected");console.log("User wallet:",l.toString());let s=await sendSolTransaction(W,D,l,new k.PublicKey(a),v.ticketPriceSOL);console.log("SOL transaction completed:",s),console.log("Verifying payment...");let r=await fetch("".concat((0,c.k)(),"/payments/verify"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(E.token)},body:JSON.stringify({transaction_hash:s,payment_intent_id:o.payment_intent_id})});if(!r.ok){let e=await r.json();throw Error(e.message||"Payment verification failed")}let i=await r.json();console.log("Payment verified:",i),console.log("Creating ticket...");let d={numbers:sortAsc(e),powerball:sortAsc(t)[0],transaction_hash:s};console.log("Ticket request data:",d),console.log("Ticket request JSON:",JSON.stringify(d));let u=await fetch("".concat((0,c.k)(),"/tickets"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(E.token)},body:JSON.stringify(d)});if(console.log("Ticket response status:",u.status),console.log("Ticket response headers:",Object.fromEntries(u.headers.entries())),!u.ok){let e=await u.json().catch(()=>({}));throw console.error("Ticket creation failed:",e),console.error("Response status:",u.status,u.statusText),Error(e.message||"Failed to create ticket: ".concat(u.status," ").concat(u.statusText))}let g=await u.json();console.log("Ticket created:",g);let m={id:g.ticketId||Date.now(),date:new Date().toISOString(),main:sortAsc(e),stars:sortAsc(t),price:v.ticketPriceSOL,txSig:s};j(e=>[m,...e]),console.log("Refreshing jackpot and countdown after ticket purchase..."),await fetchJackpot(),await fetchCountdown(),alert("Ticket purchased! You played 1 ticket • ".concat(v.ticketPriceSOL," SOL")),clearPick()}catch(e){console.error("Purchase failed:",e),alert("Error: ".concat(e instanceof Error?e.message:"Failed to purchase ticket"))}finally{I(!1)}}function formatDate(e){let t=new Date(e);return t.toLocaleString()}return N?"activity"===r?(0,o.jsxs)("div",{className:"mx-auto max-w-md bg-black text-white min-h-screen",children:[(0,o.jsxs)("div",{className:"sticky top-0 z-30 bg-black border-b border-neutral-800 px-4 py-3 flex items-center gap-2",children:[(0,o.jsx)(d,{size:"icon",variant:"ghost",onClick:()=>i("home"),children:(0,o.jsx)(m.Z,{className:"h-5 w-5 text-neutral-400"})}),(0,o.jsx)("div",{className:"text-lg font-semibold",children:"My Activity"}),E&&!R&&(0,o.jsx)("div",{className:"ml-auto",children:(0,o.jsx)(d,{size:"icon",variant:"ghost",onClick:()=>U(),className:"text-red-400 hover:text-red-300 hover:bg-red-900/20",title:"Disconnect wallet",children:(0,o.jsx)(h.Z,{className:"h-5 w-5"})})})]}),(0,o.jsx)("div",{className:"p-4",children:0===u.length?(0,o.jsx)("div",{className:"text-sm text-neutral-400",children:"No tickets yet."}):(0,o.jsx)("div",{className:"space-y-3",children:u.map(e=>(0,o.jsxs)("div",{className:"rounded-2xl border border-neutral-800 bg-neutral-900 p-3",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between",children:[(0,o.jsx)("div",{className:"text-xs text-neutral-400",children:formatDate(e.date)}),(0,o.jsxs)("div",{className:"text-xs text-neutral-400",children:[e.price," SOL"]})]}),(0,o.jsxs)("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[e.main.map(t=>(0,o.jsx)("span",{className:"inline-flex h-7 min-w-7 items-center justify-center rounded-full bg-neutral-800 px-2 text-sm font-semibold",children:t},"m-".concat(e.id,"-").concat(t))),(0,o.jsx)("span",{className:"mx-1 text-neutral-600",children:"•"}),e.stars.map(t=>(0,o.jsxs)("span",{className:"inline-flex h-7 min-w-7 items-center justify-center rounded-full bg-yellow-500/20 px-2 text-sm font-semibold text-yellow-300",children:["★ ",t]},"s-".concat(e.id,"-").concat(t)))]}),(0,o.jsx)("div",{className:"mt-2 text-xs",children:(0,o.jsx)("a",{className:"underline text-neutral-300",href:"https://solscan.io/tx/".concat(e.txSig),target:"_blank",rel:"noreferrer",children:"View on Solscan"})})]},e.id))})})]}):(0,o.jsxs)("div",{className:"mx-auto max-w-md pb-28 bg-black text-white min-h-screen",children:[(0,o.jsx)("div",{className:"sticky top-0 z-30 bg-black",children:(0,o.jsxs)("div",{className:"px-4 pt-4 pb-3 border-b border-neutral-800",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsx)(f.Z,{className:"h-5 w-5 text-yellow-400"}),(0,o.jsx)("span",{className:"text-sm text-neutral-400",children:"Global Mega Jackpot"})]}),(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsxs)(d,{size:"sm",className:"bg-purple-600 text-white",onClick:flashPickAndBuy,children:[(0,o.jsx)(p.Z,{className:"mr-1 h-4 w-4"})," Flash \xb7 ",v.ticketPriceSOL," SOL"]}),(0,o.jsx)(d,{size:"icon",variant:"ghost",onClick:()=>i("activity"),children:(0,o.jsx)(x.Z,{className:"h-5 w-5 text-neutral-400"})}),E&&!R&&(0,o.jsx)(d,{size:"icon",variant:"ghost",onClick:()=>U(),className:"text-red-400 hover:text-red-300 hover:bg-red-900/20",title:"Disconnect wallet",children:(0,o.jsx)(h.Z,{className:"h-5 w-5"})})]})]}),(0,o.jsx)("div",{className:"text-3xl font-extrabold tracking-tight",children:T?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("span",{className:"text-yellow-400",children:[T.pot.current_amount.toFixed(2)," SOL"]}),(0,o.jsx)("span",{className:"text-neutral-400 ml-2",children:"Jackpot"})]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("span",{className:"text-neutral-400",children:"Loading..."}),(0,o.jsx)("span",{className:"text-neutral-400 ml-2",children:"Jackpot"})]})}),(0,o.jsxs)("div",{className:"mt-2 flex items-center justify-between",children:[C?(0,o.jsxs)("div",{className:"flex items-center gap-2 text-xs text-neutral-400",children:[(0,o.jsx)(g.Z,{className:"h-3 w-3"}),"Draw in ",C.countdown.formatted]}):(0,o.jsx)(Countdown,{target:J}),(0,o.jsx)("div",{className:"rounded-full border border-neutral-800 bg-neutral-900 px-3 py-1 text-xs text-neutral-400",children:C?(0,o.jsxs)(o.Fragment,{children:[C.next_draw.day," ",C.next_draw.time]}):v.scheduleLabel})]})]})}),(0,o.jsxs)("div",{className:"p-4",children:[N&&O&&(0,o.jsx)("div",{className:"mb-4 p-3 bg-red-900/20 border border-red-800 rounded-lg text-red-300 text-sm",children:O}),N&&E&&R&&(0,o.jsx)("div",{className:"mb-4 p-3 bg-yellow-900/20 border border-yellow-800 rounded-lg text-yellow-300 text-sm",children:"Account changed. Please reconnect to continue."}),N&&E&&!R&&W&&!F&&(0,o.jsx)("div",{className:"mb-4 p-3 bg-blue-900/20 border border-blue-800 rounded-lg text-blue-300 text-sm",children:"Wallet connection restored. You can continue playing."}),N&&0===z.length&&(0,o.jsx)("div",{className:"mb-4 p-3 bg-yellow-900/20 border border-yellow-800 rounded-lg text-yellow-300 text-sm",children:"No wallet detected. Please install Phantom wallet and refresh the page."}),N&&z.length>0&&!W&&(0,o.jsxs)("div",{className:"mb-4 p-3 bg-blue-900/20 border border-blue-800 rounded-lg text-blue-300 text-sm",children:["Wallets detected: ",z.map(e=>e.adapter.name).join(", "),". Please select a wallet to connect."]}),N&&E&&(0,o.jsxs)("div",{className:"px-4 py-2 bg-neutral-900 rounded-lg mb-4",children:[(0,o.jsx)("div",{className:"text-xs text-neutral-400 mb-1",children:"Connected Wallet:"}),(0,o.jsxs)("div",{className:"text-sm text-green-400 font-mono",children:[E.walletAddress.slice(0,8),"...",E.walletAddress.slice(-8)]})]}),(0,o.jsx)("div",{className:"mb-3",children:(0,o.jsx)("div",{className:"text-sm text-neutral-400",children:"Pick numbers (5 + 1)"})}),(0,o.jsx)(GridPicker,{title:"".concat(v.main.label," (1–").concat(v.main.max,")"),max:v.main.max,needed:v.main.count,selected:e,onToggle:toggleMain}),(0,o.jsx)(GridPicker,{title:"".concat(v.stars.label," (1–").concat(v.stars.max,")"),max:v.stars.max,needed:v.stars.count,selected:n,onToggle:toggleStar}),(0,o.jsxs)("div",{className:"mt-4 flex items-center justify-between",children:[(0,o.jsx)(d,{variant:"ghost",className:"text-neutral-400",onClick:clearPick,children:"Clear"}),(0,o.jsxs)("div",{className:"text-xs text-neutral-500",children:["Price per ticket: ",v.ticketPriceSOL," SOL"]})]})]}),(0,o.jsx)(l.M,{children:(0,o.jsx)("div",{className:"fixed inset-x-0 bottom-0 z-50 mx-auto max-w-md border-t border-neutral-800 bg-black p-3",style:{pointerEvents:"auto"},children:(0,o.jsx)("button",{className:"w-full text-base bg-purple-600 text-white hover:bg-purple-700 px-4 py-2 rounded-md",onClick:playNow,style:{pointerEvents:"auto"},children:_?"Connecting...":R?"Connect":E?"Play \xb7 ".concat(v.ticketPriceSOL," SOL"):"Connect"})})})]}):(0,o.jsx)("div",{className:"mx-auto max-w-md bg-black text-white min-h-screen flex items-center justify-center",children:(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"}),(0,o.jsx)("div",{className:"text-neutral-400",children:"Loading..."})]})})}},9560:function(e,t,n){"use strict";n.r(t),n.d(t,{AuthProvider:function(){return AuthProvider},useAuth:function(){return useAuth}});var o=n(7437),a=n(2265),l=n(3446),s=n(1628),r=n(7133).Buffer;let c=(0,a.createContext)(void 0);function AuthProvider(e){let{children:t}=e,{wallet:n,publicKey:i,connected:d,connect:u,disconnect:g,wallets:m}=(0,l.O)(),[h,f]=(0,a.useState)(null),[p,x]=(0,a.useState)(!1),[w,b]=(0,a.useState)(null),[y,k]=(0,a.useState)(!1);(0,a.useEffect)(()=>{var e,t;console.log("AuthContext wallet state changed:",{wallet:null==n?void 0:null===(e=n.adapter)||void 0===e?void 0:e.name,connected:d,publicKey:null==i?void 0:i.toString(),walletReady:null==n?void 0:null===(t=n.adapter)||void 0===t?void 0:t.readyState}),(null==n?void 0:n.adapter)&&!d&&console.log("Wallet adapter available:",{name:n.adapter.name,readyState:n.adapter.readyState,connected:n.adapter.connected})},[n,d,i]),(0,a.useEffect)(()=>{let e=localStorage.getItem("auth_token"),t=localStorage.getItem("wallet_address");e&&t&&(console.log("Found existing token:",e),console.log("Token length:",e.length),console.log("Stored wallet address:",t),validateToken(e).then(n=>{if(n){console.log("Token is valid, setting user"),f({walletAddress:t,token:e}),console.log("Attempting to restore wallet connection...");let n=m.find(e=>"Phantom"===e.adapter.name);n&&"Installed"===n.adapter.readyState&&console.log("Phantom wallet is available, checking if we can restore connection")}else console.log("Token is invalid, clearing storage"),localStorage.removeItem("auth_token"),localStorage.removeItem("wallet_address")}))},[m]),(0,a.useEffect)(()=>{if(!(null==n?void 0:n.adapter))return;let handleAccountChange=()=>{if(y){console.log("Already disconnecting, ignoring account change event");return}console.log("Account changed, disconnecting user"),k(!0),localStorage.removeItem("auth_token"),localStorage.removeItem("wallet_address"),f(null),b(null),setTimeout(()=>{k(!1)},1e3)};return n.adapter.on("disconnect",handleAccountChange),h&&h.walletAddress&&!d&&"Installed"===n.adapter.readyState&&(console.log("Attempting to restore wallet connection for existing user..."),setTimeout(async()=>{try{await n.adapter.connect(),console.log("Wallet connection restored successfully")}catch(e){console.log("Could not restore wallet connection automatically:",e)}},1e3)),()=>{n.adapter.off("disconnect",handleAccountChange)}},[n,g,h,d]);let signMessage=async e=>{let t=n;if(!t||!t.adapter.publicKey){let e=m.find(e=>"Phantom"===e.adapter.name&&e.adapter.publicKey);e&&(t=e,console.log("Using Phantom wallet from available wallets for signing"))}if(!t||!t.adapter.publicKey)throw Error("Wallet not connected");try{let n=new TextEncoder().encode(e);if(!("signMessage"in t.adapter)||"function"!=typeof t.adapter.signMessage)throw Error("Wallet does not support message signing");let o=await t.adapter.signMessage(n);return r.from(o).toString("base64")}catch(e){throw console.error("Sign message error:",e),Error("Failed to sign message")}},validateToken=async e=>{try{console.log("Validating token..."),console.log("Token being validated:",e),console.log("Authorization header:","Bearer ".concat(e));let t=await fetch("".concat((0,s.k)(),"/auth/me"),{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(console.log("Token validation response:",t.status),!t.ok){let e=await t.json().catch(()=>({}));console.log("Token validation error:",e)}return t.ok}catch(e){return console.error("Token validation failed:",e),!1}},connectWallet=async()=>{console.log("Attempting to connect wallet..."),console.log("Available wallet:",n),console.log("Connected:",d),console.log("Public key:",i),console.log("Available wallets in AuthContext:",m.map(e=>e.adapter.name));let e=m.find(e=>"Phantom"===e.adapter.name);if(!e){b("No Phantom wallet found. Please install Phantom wallet and refresh the page."),x(!1);return}console.log("Using Phantom wallet directly for connection"),b(null),x(!0);try{console.log("Connecting with Phantom wallet directly...");try{let t=await e.adapter.connect();console.log("Phantom wallet connect result:",t)}catch(e){console.log("Direct Phantom connect failed:",e),console.log("Trying useWallet connect() as fallback...");try{await u(),console.log("useWallet connect() successful")}catch(e){throw console.log("useWallet connect() also failed:",e),Error("Failed to connect to Phantom wallet")}}await new Promise(e=>setTimeout(e,1e3));let t=null;if(e&&e.adapter.publicKey?(t=e.adapter.publicKey,console.log("Got public key from direct Phantom wallet")):n&&n.adapter&&n.adapter.publicKey?(t=n.adapter.publicKey,console.log("Got public key from selected wallet")):i&&(t=i,console.log("Got public key from useWallet hook")),console.log("Wallet public key (first attempt):",t),!t){console.log("Public key not available, retrying...");for(let o=0;o<10&&(await new Promise(e=>setTimeout(e,300)),e&&e.adapter.publicKey?t=e.adapter.publicKey:n&&n.adapter&&n.adapter.publicKey?t=n.adapter.publicKey:i&&(t=i),console.log("Retry ".concat(o+1,":"),t),!t);o++);}if(!t)throw Error("Failed to get public key from wallet adapter after retries. Please try connecting again.");let o=t.toString(),a="Sign this message to authenticate with Crypto EuroMillions.\nWallet: ".concat(o,"\nTimestamp: ").concat(Date.now());console.log("Signing message...");let l=await signMessage(a);console.log("Message signed successfully"),console.log("Signature length:",l.length),console.log("Signature preview:",l.substring(0,20)+"..."),console.log("Sending to backend...");let r={wallet_address:o,signature:l,message:a};console.log("Request data:",r),console.log("Request JSON:",JSON.stringify(r));let c=await fetch("".concat((0,s.k)(),"/auth/wallet-connect"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!c.ok){console.log("Wallet connect failed:",c.status);let e=await c.json();throw console.log("Connect error response:",e),Error(e.message||"Wallet connect failed with status ".concat(c.status))}let d=await c.json();console.log("Wallet connect successful:",d);let g=d.token||d.access_token||d.auth_token;if(!g){console.log("No token in connect response, trying to register user...");let e=await fetch("".concat((0,s.k)(),"/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({wallet_address:o})});if(e.ok){let t=await e.json();console.log("User registration successful:",t),g=t.token||t.access_token||t.auth_token}else if(409===e.status){console.log("User already exists, getting user info...");let e=await fetch("".concat((0,s.k)(),"/auth/me"),{method:"GET",headers:{"Content-Type":"application/json"}});if(e.ok){let t=await e.json();console.log("User info retrieved:",t),g=t.token||t.access_token||t.auth_token}}else{console.log("User registration failed:",e.status);let t=await e.json();throw console.log("Register error response:",t),Error(t.message||"User registration failed with status ".concat(e.status))}}if(!g)throw Error("No token found after authentication");console.log("Authentication successful"),console.log("Token received:",g),console.log("Token length:",g.length),console.log("Token type:",typeof g),localStorage.setItem("auth_token",g),localStorage.setItem("wallet_address",o),f({walletAddress:o,token:g})}catch(e){console.error("Authentication error:",e),e instanceof TypeError&&e.message.includes("Failed to fetch")?b("Backend server not running. Please start your backend on port 3001."):b(e instanceof Error?e.message:"Authentication failed")}finally{x(!1)}},disconnect=async()=>{var e,t;if(y){console.log("Already disconnecting, ignoring disconnect request");return}console.log("Disconnecting user..."),console.log("Current wallet state:",{connected:d,wallet:null==n?void 0:null===(e=n.adapter)||void 0===e?void 0:e.name}),k(!0),localStorage.removeItem("auth_token"),localStorage.removeItem("wallet_address"),f(null),b(null),x(!1);try{(null==n?void 0:null===(t=n.adapter)||void 0===t?void 0:t.connected)||d?(console.log("Wallet is connected, disconnecting..."),await g(),console.log("Wallet disconnect completed")):console.log("Wallet was not connected")}catch(e){console.log("Error during wallet disconnect:",e)}setTimeout(()=>{k(!1),console.log("User disconnected successfully")},500)};return(0,o.jsx)(c.Provider,{value:{user:h,isLoading:p,error:w,connectWallet,disconnect,signMessage,validateToken,wallet:n,connected:d,publicKey:i,setIsLoading:x},children:t})}function useAuth(){let e=(0,a.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},1628:function(e,t,n){"use strict";n.d(t,{cn:function(){return cn},k:function(){return getApiUrl}});var o=n(7042),a=n(4769),l=n(5566);function cn(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,a.m6)((0,o.W)(t))}function getApiUrl(){return l.env.NEXT_PUBLIC_API_URL||"http://localhost:3001"}}},function(e){e.O(0,[814,107,187,971,472,744],function(){return e(e.s=7961)}),_N_E=e.O()}]);